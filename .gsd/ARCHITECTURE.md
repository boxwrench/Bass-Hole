# Architecture

> Generated by /map on 2026-01-19

## Overview

Bass Hole is an **Insaniquarium-style game for ESP32 CYD** (Cheap Yellow Display). It's designed as both a playable embedded game and an educational reference for ESP32 CYD development, demonstrating touch input, entity systems, state management, SD card I/O, and sprite rendering on resource-constrained hardware.

**Core Gameplay Loop:**
1. Player taps screen to drop food pellets
2. Fish swim, eat food, grow, and drop coins
3. Player taps coins to collect currency
4. Currency buys new fish
5. Game ends if all fish starve and player can't afford new ones

**Platforms:**
- **Hardware:** ESP32 CYD 2.4" (TZT/Sunton variants)
- **Development:** PlatformIO with Arduino framework
- **Simulation:** Wokwi (for testing without hardware)

## System Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                      main.cpp                               │
│                   (Main Entry Point)                        │
│  - setup(): Initialize hardware + game systems              │
│  - loop(): Game loop (input → update → render)              │
└─────────────────────────────────────────────────────────────┘
          │              │              │              │
          ▼              ▼              ▼              ▼
    ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
    │  touch   │  │   fish   │  │ graphics │  │  sdcard  │
    │  .h/.cpp │  │  .h/.cpp │  │  .h/.cpp │  │  .h/.cpp │
    └──────────┘  └──────────┘  └──────────┘  └──────────┘
    ┌──────────┐  ┌──────────┐  ┌──────────┐
    │  food    │  │  coins   │  │game_state│
    │  .h/.cpp │  │  .h/.cpp │  │  .h/.cpp │
    └──────────┘  └──────────┘  └──────────┘
          │              │              │              │
          └──────────────┴──────────────┴──────────────┘
                                 │
                          ┌──────────────┐
                          │   config.h   │
                          │  (Constants) │
                          └──────────────┘
```

## Components

### main.cpp (src/)
- **Purpose:** Main game loop and entry point
- **Location:** `src/main.cpp`
- **Responsibilities:**
  - Hardware initialization sequence (touch → display → SD card)
  - Frame rate limiting (30 FPS target)
  - Input handling dispatch based on game state
  - State transition detection
  - FPS monitoring and debug output
  - Dirty rectangle rendering coordination
- **Key Pattern:** State-driven rendering with dirty rect optimization

### config.h (include/)
- **Purpose:** Single source of truth for all configuration
- **Location:** `include/config.h`
- **Contains:**
  - Hardware pin definitions (SPI, touch, display)
  - Display colors (RGB565 palette)
  - Game constants (speeds, sizes, entity limits)
  - Fish species configuration data
  - Game state enum
  - Debug flags (serial, FPS, touch debug)
- **Why Critical:** Changing any value here affects entire game

### game_state.h/cpp (include/src/)
- **Purpose:** Game state management and persistence
- **Location:** `include/game_state.h`, `src/game_state.cpp`
- **Key Structures:**
  - `GameData`: Current state, coins, level, high score, stats
  - `GameState` enum: BOOT, TITLE, PLAYING, GAMEOVER
- **Functions:**
  - `gameStateInit()`: Load save or initialize
  - `gameStateChange()`: Transition between states
  - `gameStateReset()`: Start new game
  - `gameSave()`/`gameLoad()`: SD card persistence
- **Pattern:** State machine with persistence layer

### fish.h/cpp (include/src/)
- **Purpose:** Fish entity management and AI
- **Location:** `include/fish.h`, `src/fish.cpp`
- **Entity Pool:** Fixed array of `MAX_FISH` (10) slots
- **Key Structures:**
  - `Fish`: position, velocity, species, hunger, growth stage
  - `FishSpecies`: Rainbow Trout, Bluegill, Largemouth Bass
- **AI Behavior:**
  1. Random target point selection
  2. Smooth acceleration toward target
  3. Hunger-driven food seeking (<50% hunger)
  4. Periodic coin drops (faster when well-fed)
  5. Starvation death mechanic
- **Functions:**
  - `fishSpawn()`: Create new fish at location
  - `fishUpdate()`: Movement, hunger, coin generation
  - `fishFeed()`: Consume food, increase growth
  - `fishGetAt()`: Hit detection for touch

### food.h/cpp (include/src/)
- **Purpose:** Food pellet management
- **Location:** `include/food.h`, `src/food.cpp`
- **Entity Pool:** Fixed array of `MAX_FOOD` (15) slots
- **Behavior:**
  - Spawns at tap location
  - Falls downward at constant speed
  - Removed when eaten or hits tank bottom
  - Simple collision detection with fish

### coins.h/cpp (include/src/)
- **Purpose:** Coin spawning and collection
- **Location:** `include/coins.h`, `src/coins.cpp`
- **Entity Pool:** Fixed array of `MAX_COINS` (20) slots
- **Behavior:**
  - Float upward slowly
  - Side-to-side bobbing motion
  - Timeout-based expiration
  - Tap-based collection
  - Currency accumulation

### touch.h/cpp (include/src/)
- **Purpose:** Touch input handling for XPT2046
- **Location:** `include/touch.h`, `src/touch.cpp`
- **Features:**
  - Debouncing to prevent double-taps
  - Raw coordinate → screen coordinate mapping
  - Tap detection (release = tap)
  - Calibration support
  - **Critical:** Must initialize BEFORE display to avoid SPI bus conflicts

### graphics.h/cpp (include/src/)
- **Purpose:** All rendering operations via TFT_eSPI
- **Location:** `include/graphics.h`, `src/graphics.cpp`
- **Rendering Layers (bottom to top):**
  1. Tank background (water gradient)
  2. Food pellets
  3. Fish
  4. Coins
  5. UI overlay (coin count, buy button)
- **Current Implementation:** Simple shapes (ellipses, circles)
- **Future:** Sprite-based rendering from SD card
- **Optimization:** Dirty rectangle clearing before entity updates

### sdcard.h/cpp (include/src/)
- **Purpose:** SD card file operations
- **Location:** `include/sdcard.h`, `src/sdcard.cpp`
- **Features:**
  - SPI initialization for SD card
  - Read/write arbitrary files
  - Game save/load with checksum validation
  - FAT32 filesystem support

### Asset Pipeline (tools/)
- **Purpose:** Convert art assets for ESP32 display
- **Location:** `tools/` directory
- **Scripts:**
  - `img2code.py`: PNG → C array (header embedding)
  - `img2raw.py`: PNG → RGB565 raw binary
  - `png_to_rgb565.py`: PNG → RGB565 conversion
  - `dither_tool.py`: Color reduction with dithering
  - `resize_sprites.py`: Batch sprite processing
- **Dependencies:** Python 3.x, Pillow, NumPy
- **Workflow:** PNG art → dithered/resized → RGB565 → SD card or C header

### Hardware Test Tool (hardware_test/)
- **Purpose:** Separate calibration and validation tool
- **Location:** `hardware_test/` subdirectory
- **Scope:** Display config, touch calibration, sprite testing
- **Pattern:** Independent PlatformIO project for hardware validation

## Data Flow

### Startup Sequence
1. **Touch Init** (MUST be first for SPI bus stability)
2. **Display Init** (TFT_eSPI setup, rotation, gamma)
3. **SD Card Init** (optional, for save/load and sprites)
4. **Game Systems Init** (fish, food, coins pools)
5. **Load Save or New Game**

### Game Loop (30 FPS target)
1. **Frame Timing:** Calculate deltaTime, enforce FRAME_TIME_MS
2. **Input Processing:** 
   - `touchUpdate()` → poll hardware
   - `handleInput()` → dispatch by state
3. **State Transition Detection:** Track state changes for full redraws
4. **Entity Updates (if PLAYING):**
   - Clear old positions (dirty rects)
   - Update physics (fish, food, coins)
   - Collision detection (fish eats food, player collects coins)
5. **Rendering:** State-specific render function
6. **FPS Calculation:** Track for debug/optimization

### Touch Input Flow
```
User Touch → XPT2046 raw coords → touchUpdate() → Debounce check
                                                        │
                                                        ▼
                                               Valid tap?
                                                        │
                                    ┌───────────────────┴────────────────┐
                                    │                                    │
                                 PLAYING?                           TITLE/GAMEOVER?
                                    │                                    │
                    ┌───────────────┼───────────────┐                   │
                    │               │               │                   │
              Coin at xy?     Tank area?     Buy button?          State change
                    │               │               │
               Collect coin    Drop food      Buy fish
```

## Integration Points

| External Service | Type | Purpose | Library |
|------------------|------|---------|---------|
| ILI9341 Display | SPI Hardware | 240x320 LCD rendering | TFT_eSPI |
| XPT2046 Touch | SPI Hardware | Resistive touchscreen | XPT2046_Touchscreen |
| SD Card | SPI Hardware | Save/load + sprite assets | SD (Arduino) |
| Wokwi Simulator | Cloud Service | Hardware emulation for testing | wokwi.toml |

## Conventions

### Naming
- **Files:** lowercase with underscores (`game_state.cpp`)
- **Functions:** camelCase with prefix (`fishSpawn`, `gfxDrawTank`)
- **Constants:** UPPER_SNAKE_CASE (`MAX_FISH`, `COLOR_WATER_DEEP`)
- **Structs:** PascalCase (`Fish`, `GameData`, `TouchPoint`)

### Structure
- **Headers:** `include/` directory
- **Implementation:** `src/` directory
- **Assets:** `assets/` for source art, `sdcard/` for runtime files
- **Tools:** `tools/` for build/conversion scripts
- **Docs:** `docs/` for design and hardware documentation

### Testing
- **Pattern:** Hardware validation via separate `hardware_test/` project
- **Simulation:** Wokwi for pre-hardware testing
- **Debug:** Conditional compilation via `DEBUG_SERIAL`, `DEBUG_FPS`, `DEBUG_TOUCH`

### Error Handling
- **Serial Output:** Debug information via Serial (115200 baud)
- **Visual Feedback:** Splash screen shows SD card status, touch OK
- **Graceful Degradation:** Game runs without SD card (no save/load)

## Entity Pool Pattern

All entities (fish, food, coins) use fixed-size arrays with active/inactive slots:

```cpp
Fish fishPool[MAX_FISH];  // Pre-allocated array
uint8_t fishCount = 0;    // Active count

Fish* fishSpawn(...) {
    for (int i = 0; i < MAX_FISH; i++) {
        if (!fishPool[i].active) {
            fishPool[i].active = true;
            fishCount++;
            return &fishPool[i];
        }
    }
    return nullptr;  // Pool full
}

void fishRemove(Fish* fish) {
    fish->active = false;
    fishCount--;
}
```

**Rationale:**
- ✅ No dynamic allocation (prevents heap fragmentation)
- ✅ Predictable memory usage
- ✅ Cache-friendly iteration
- ✅ Simple and fast

## State Machine

```
          ┌─────────┐
          │  BOOT   │ (splash screen)
          └────┬────┘
               ▼
          ┌─────────┐
     ┌────│  TITLE  │ (tap to start)
     │    └────┬────┘
     │         ▼
     │    ┌─────────┐
     │    │ PLAYING │◄──────────────┐
     │    └────┬────┘               │
     │         │                    │
     │    ┌────┴────┐         ┌─────┴─────┐
     │    ▼         ▼         │           │
     │ ┌──────┐ ┌──────┐      │           │
     │ │ SHOP │ │ BOSS │──────┘           │
     │ └──┬───┘ └──────┘ (future)         │
     │    └───────────────────────────────┘
     │
     │    ┌──────────┐
     └───►│ GAMEOVER │ (tap to restart)
          └──────────┘
```

## Memory Budget

ESP32 has ~520KB SRAM. Current usage estimate:

| System | Approximate Size |
|--------|------------------|
| Fish pool (10 fish) | ~600 bytes |
| Food pool (15 pellets) | ~200 bytes |
| Coin pool (20 coins) | ~400 bytes |
| Game state | ~100 bytes |
| Display buffer (TFT_eSPI internal) | ~2KB |
| **Total Core Game** | **~3-4KB** |

**Headroom:** ~516KB available for sprites, sound buffers, and future features.

## Technical Debt

- [ ] README.md: Placeholder comment for gameplay GIF (line 13)
- [ ] Touch calibration values are device-specific (needs per-board tuning)
- [ ] Sprite system planned but not implemented (currently using simple shapes)
- [ ] No automated tests (relies on hardware validation + manual testing)
- [ ] Dirty rect optimization only partially implemented (full background redraw on state entry)
- [ ] Audio system designed but not implemented (DAC output planned)
- [ ] Dialogue system (Ty Knotts narrator) designed but not implemented

## Critical Findings from Development History

1. **SPI Bus Order:** Touch MUST initialize before display to avoid bus conflicts
2. **Display Configuration:** ILI9341_DRIVER with TFT_RGB_ORDER=1 (BGR) for correct colors
3. **Sprite Rendering:** PNG decoding works but RGB565 pre-conversion is more performant
4. **Color Handling:** Alpha blending against black background during PNG→RGB565 conversion
5. **Rotation:** `rotation(3)` for "Portrait with USB down" orientation
6. **FPS Optimization:** Dirty rect clearing achieves ~31 FPS on hardware

## Future Architecture Plans

### Phase: Sprite System
- Add sprite loading from SD card (PNG or RGB565 raw)
- Sprite caching in RAM for frequently used assets
- Animated sprite sheet support

### Phase: Dialogue System
- Ty Knotts narrator with event-triggered lines
- Text rendering with word wrap
- Sarcastic commentary based on player actions

### Phase: Audio System
- ESP32 DAC output for sound effects
- 8-bit style tone generation
- Optional SD card WAV playback

### Phase: Enemy System
- Clankers (machines that attack fish)
- Boss battles with AI parody characters
- Projectile/attack patterns

### Phase: Shop System
- Upgrades (food quality, fish capacity, automation)
- New fish species unlock
- Persistent progression across saves

---

*This architecture document reflects the state of the codebase as of Phase 1 hardware verification.*
